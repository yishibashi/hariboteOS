     1                                  ; hello-os
     2                                  ; TAB=4
     3                                  
     4                                  CYLS    EQU     10              ; どこまで読み込むか (CYLinderS)
     5                                  
     6                                  		ORG		0x7c00			; このプログラムがどこに読み込まれるのか
     7                                  
     8                                  ; 以下は標準的なFAT12フォーマットフロッピーディスクのための記述
     9                                  
    10 00000000 EB4E                    		JMP		entry
    11 00000002 90                      		DB		0x90
    12 00000003 48454C4C4F49504C        		DB		"HELLOIPL"		; ブートセクタの名前を自由に書いてよい（8バイト）
    13 0000000B 0002                    		DW		512				; 1セクタの大きさ（512にしなければいけない）
    14 0000000D 01                      		DB		1				; クラスタの大きさ（1セクタにしなければいけない）
    15 0000000E 0100                    		DW		1				; FATがどこから始まるか（普通は1セクタ目からにする）
    16 00000010 02                      		DB		2				; FATの個数（2にしなければいけない）
    17 00000011 E000                    		DW		224				; ルートディレクトリ領域の大きさ（普通は224エントリにする）
    18 00000013 400B                    		DW		2880			; このドライブの大きさ（2880セクタにしなければいけない）
    19 00000015 F0                      		DB		0xf0			; メディアのタイプ（0xf0にしなければいけない）
    20 00000016 0900                    		DW		9				; FAT領域の長さ（9セクタにしなければいけない）
    21 00000018 1200                    		DW		18				; 1トラックにいくつのセクタがあるか（18にしなければいけない）
    22 0000001A 0200                    		DW		2				; ヘッドの数（2にしなければいけない）
    23 0000001C 00000000                		DD		0				; パーティションを使ってないのでここは必ず0
    24 00000020 400B0000                		DD		2880			; このドライブ大きさをもう一度書く
    25 00000024 000029                  		DB		0,0,0x29		; よくわからないけどこの値にしておくといいらしい
    26 00000027 FFFFFFFF                		DD		0xffffffff		; たぶんボリュームシリアル番号
    27 0000002B 48454C4C4F2D4F5320-     		DB		"HELLO-OS   "	; ディスクの名前（11バイト）
    27 00000034 2020               
    28 00000036 4641543132202020        		DB		"FAT12   "		; フォーマットの名前（8バイト）
    29                                  		; RESB	18				; とりあえず18バイトあけておく
    30 0000003E 00<rept>                		TIMES	18	DB 0		; とりあえず18バイトあけておく
    31                                  
    32                                  ; プログラム本体
    33                                  
    34                                  entry:
    35 00000050 B80000                  		MOV		AX,0			; レジスタ初期化
    36 00000053 8ED0                    		MOV		SS,AX
    37 00000055 BC007C                  		MOV		SP,0x7c00
    38 00000058 8ED8                    		MOV		DS,AX
    39                                  
    40                                  ; ディスクを読む
    41                                  
    42 0000005A B82008                  		MOV		AX,0x0820
    43 0000005D 8EC0                    		MOV		ES,AX
    44 0000005F B500                    		MOV		CH,0			; シリンダ0
    45 00000061 B600                    		MOV		DH,0			; ヘッド0
    46 00000063 B102                    		MOV		CL,2			; セクタ2
    47                                  
    48                                  readloop:
    49 00000065 BE0000                  		MOV		 SI,0			; 失敗回数を数えるレジスタ
    50                                  
    51                                  retry:
    52 00000068 B402                    		MOV		AH,0x02			; AH=0x02 : ディスク読み込み
    53 0000006A B001                    		MOV		AL,1			; 1セクタ
    54 0000006C BB0000                  		MOV		BX,0
    55 0000006F B200                    		MOV		DL,0x00			; Aドライブ
    56 00000071 CD13                    		INT		0x13			; ディスクBIOS呼び出し
    57 00000073 7310                    		JNC		next			; エラーが起きなければnextへ
    58 00000075 83C601                  		ADD		SI,1			; SIに１を足す
    59 00000078 83FE05                  		CMP		SI,5			; SIと５を比較
    60 0000007B 733F                    		JAE		error			; SI >= 5だったらerrorへ
    61 0000007D B400                    		MOV		AH,0x00			; MOV AH,0x00 MOV DL,0x00 INT 0x13 で, (AT)BIOSのページによると，システムのリセット
    62 0000007F B200                    		MOV		DL,0x00			; Aドライブ
    63 00000081 CD13                    		INT		0x13			; ドライブのリセット
    64 00000083 EBE3                    		JMP		retry
    65                                  
    66                                  next:
    67 00000085 8CC0                    		MOV		AX,ES			; アドレスを0x200進める, 0x20 = 512/16
    68 00000087 83C020                  		ADD		AX,0x0020
    69 0000008A 8EC0                    		MOV		ES,AX			; ADD ES,0x020 という命令がないのでこうする.
    70 0000008C 80C101                  		ADD		CL,1			; CLに１を足す
    71 0000008F 80F912                  		CMP		CL,18			; CLと18を比較
    72 00000092 76D1                    		JBE		readloop		; CL <= 18 だったらreadloopへ
    73 00000094 B101                    		MOV		CL,1
    74 00000096 80C601                  		ADD		DH,1
    75 00000099 80FE02                  		CMP		DH,2
    76 0000009C 72C7                    		JB		readloop		; DH < 2 だったらreadloopへ
    77 0000009E B600                    		MOV		DH,0
    78 000000A0 80C501                  		ADD		CH,1
    79 000000A3 80FD0A                  		CMP		CH,CYLS
    80 000000A6 72BD                    		JB		readloop
    81 000000A8 B600                    		MOV		DH,0
    82 000000AA 80C501                  		ADD		CH,1
    83 000000AD 80FD0A                  		CMP		CH,CYLS
    84 000000B0 72B3                    		JB		readloop		; CH < CYLS だったらreadloopへ
    85                                  
    86                                  ; 読み終わったのでharibote.sysを実行だ
    87 000000B2 882EF00F                		MOV		[0x0ff0], CH 
    88 000000B6 E9(00C2)                		JMP		0xc200
    89                                  
    90                                  fin:
    91 000000B9 F4                      		HLT						; 何かあるまでCPUを停止させる
    92 000000BA EBFD                    		JMP		fin				; 無限ループ
    93                                  
    94                                  error:
    95 000000BC BE[D100]                		MOV		SI,msg
    96                                  
    97                                  putloop:
    98 000000BF 8A04                    		MOV		AL,[SI]
    99 000000C1 83C601                  		ADD		SI,1			; SIに1を足す
   100 000000C4 3C00                    		CMP		AL,0
   101 000000C6 74F1                    		JE		fin
   102 000000C8 B40E                    		MOV		AH,0x0e			; 一文字表示ファンクション
   103 000000CA BB0F00                  		MOV		BX,15			; カラーコード
   104 000000CD CD10                    		INT		0x10			; ビデオBIOS呼び出し
   105 000000CF EBEE                    		JMP		putloop
   106                                  
   107                                  msg:
   108 000000D1 0A0A                    		DB		0x0a, 0x0a		; 改行を2つ
   109 000000D3 6C6F6164206572726F-     		DB		"load error"
   109 000000DC 72                 
   110 000000DD 0A                      		DB		0x0a			; 改行
   111 000000DE 00                      		DB		0
   112                                  
   113                                  		;RESB	0x7dfe-$		; 0x7dfeまでを0x00で埋める命令
   114 000000DF 00<rept>                		TIMES	0x7dfe-0x7c00-($-$$)	DB	0
   115                                  
   116 000001FE 55AA                    		DB		0x55, 0xaa
   117                                  
